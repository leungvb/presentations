<!DOCTYPE html>
<html>
  <head>
    <title>Docker for Python Developers</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      table {
        width: 60%;
        border-collapse: collapse;
      }

      table, th, td {
        border: 1px solid black;
      }
      th, td {
        padding: 5px;
        text-align: left;
      }
      td {
        padding-left: 5px;
        padding-right: 5px;
      }
      .remark-code { font-family: 'Ubuntu Mono'; }
      .remark-inline-code {
        font-family: 'Ubuntu Mono';
        padding: 2px 4px;
        font-size: 90%;
        color: #c7254e;
        background-color: #f9f2f4;
        border-radius: 0;
       }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Docker for Python Developers

[Fitter](https://www.youtube.com/watch?v=hs64rB0cLNw). [Happier](https://www.youtube.com/watch?v=My10FLH5DT0). [More productive](https://www.youtube.com/watch?v=9ORllD7fA6I).

<img src="images/docker.png" alt="docker logo" style="width:20%;">

<br>

<div>
  <span style="vertical-align:60%;">Presented by <em>Michael Herman</em> at</span>&nbsp;
  <img src="images/dockercon.png" style="max-width: 10%; border:0; box-shadow: none;" alt="DockerCon 2018">
</div>


---

### Agenda

--

##### (1) Intro

1. About Me
1. Objectives (wip)

--

##### (2) Best Practices

1. Keep Docker Images Slim with Alpine
1. Use Multi-stage Builds
1. Version Docker Images
1. Minimize the Number of Layers (wip)
1. Order Dockerfile statements (wip)
1. Create a non-root user (wip)
1. Use Docker Compose (wip)
1. Keep secrets safe (wip)

--

##### (3) Goodbye

1. Next Steps (wip)
1. Questions (wip)

---

class: center, middle

## Intro

---

### About Michael

```
$ whoami
michael.herman
```

--

#### Day Job:

Software Engineer at [ClickFox](https://www.clickfox.com/).
&nbsp;
<img src="images/clickfox.png" style="max-width: 4%; border:0; box-shadow: none;" alt="clickfox logo">

--

#### Docker:

1. Avid Docker user since 2014.
1. Last year I architected and set up [On-Demand Environments With Docker and AWS ECS](http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs/).

--

#### Also:

1. Co-founder/author of [Real Python](https://realpython.com)
1. üòç - [tech writing/education](http://mherman.org), [open source](http://github.com/mjhea0), [financial models](http://www.starterfinancialmodel.com/), [radiohead](http://radiohead.com/)

<img src="images/me.png" style="max-width: 10%; border:0; box-shadow: none; padding-top:10px" alt="me">

---

### TestDriven.io

Started [Testdriven.io](http://testdriven.io/) late 2017...

<br>

<div class="grid">
  <div style="float: left; width: 45%;">
    <div text-align="center">
      <img src="images/cover_small.png" style="max-width: 80%; border:2px solid; border-color:grey; box-shadow: none;" alt="microservice tech">
    </div>
  </div>
  <div style="float: left; width: 55%;">
    <h4 style="margin-top: 0;"><em>Microservices with Docker, Flask, and React</em></h4>
    <p>Learn how to build, test, and deploy microservices powered by Docker, Flask, and React!</p>
    <ul>
      <li>Test-driven Development (TDD)</li>
      <li>AWS ECS, RDS, and Lambda</li>
      <li>React</li>
      <li>Blue/Green Deploys</li>
      <li>CI/CD</li>
    </ul>
  </div>
</div>

<div class="center">
  <img src="images/mobile_image.png" style="max-width: 15%; padding-top:30px; box-shadow: none;" alt="testdriven.io">
</div>

---

### Objectives

By the end of this talk, you should be able to...

--

1. Use **Alpine Linux** based images as a starting point for your Dockerfiles

--

1. Create lean, production-ready images using **multi-stage builds**

--

1. **Version Docker images** with Docker tags

---

class: center, middle

## Best Practices

---

### Keep Docker Images Slim with Alpine (1)

Use [Alpine Linux](https://hub.docker.com/_/alpine/) based images since they come only with the packages you need. Resulting images will be smaller.

--

#### What are the benefits?

--

1. Decreased hosting costs since less disk space is used
1. Quicker build, download, and run times
1. More secure (since there are less packages and libraries)

--

#### Web Development Example

```sh
FROM python:3.6-alpine

WORKDIR /app

COPY requirements.txt /
RUN pip install -r /requirements.txt  # flask and gunicorn

COPY . /app
```

1. Size before: 702MB
1. Size after: 102MB

---

### Keep Docker Images Slim with Alpine (2)

--

#### Data Science Example

```sh
FROM python:3.6-alpine

RUN apk --no-cache add --virtual build-dependencies \
                build-base \
                python3-dev \
        && pip3 install \
                jupyter \
                pandas

WORKDIR /notebooks
```

1. Size before: 929MB
1. Size after: 634MB

<br>

<img src="images/alpine.jpg" style="max-width: 10%; border:0; box-shadow: none; padding-left:10px;" alt="alpine linux">

---

### Use Multi-stage Builds (1)

Take advantage of [multi-stage builds](https://docs.docker.com/develop/develop-images/multistage-build/) to create a temp image used for building artifacts that will be copied over to the production image. The temp build image is discarded along with the original files, folders, and dependencies associated with the image.

This produces a lean, production-ready image.

--

One use case is to use a non-Alpine base to install dependnecies that require compilation. The wheel files can then be copied over to the final image.

--

#### Web Development Example

```sh
FROM python:3.6 as base
COPY requirements.txt /
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /wheels -r requirements.txt

FROM python:3.6-alpine
COPY --from=base /wheels /wheels
COPY --from=base requirements.txt .
RUN pip install --no-cache /wheels/* # flask, gunicorn, pycrypto
WORKDIR /app
COPY . /app
```

Size before: 705MB, Size after: 103MB

---

### Use Multi-stage Builds (2)

#### Data Science Example

```sh
FROM python:3.6 as base
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /wheels jupyter pandas

FROM python:3.6-slim
COPY --from=base /wheels /wheels
RUN pip install --no-cache /wheels/*
WORKDIR /notebooks
```

Size before: 929MB, Size after: 365MB

--

#### CI Example

```sh
FROM python:3.6 as base
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /wheels -r flask
COPY . /app
RUN py.test # What happens if the tests fail?

FROM python:3.6-alpine
COPY --from=base /wheels /wheels
RUN pip install --no-cache /wheels/*
WORKDIR /app
COPY . /app
```

---

### Version Docker Images

If you rely on just using the `latest` tag, you'll have know real way of knowing which image version is actually running in a specific environment.

--

### How?

--

1. timestamps
1. image ids
1. Git commit hashes

--

### Example

You could use both the git commit SHA1 hash (to associate the image back to a specific commit to help with debugging) along with and the environment name:

`/$PROJECT/$ENVIRONMENT:$SHA1`

```sh
$ docker build -t web/prod:a072c4e5d94b5a769225f621f08af3d4bf820a07 .
```

---

### Minimize the Number of Layers

---

### Order Dockerfile statements

---

### Create a non-root user

---

### Use Docker Compose

---

### That's it!

What's next?

--

##### Check your understanding

1. [Secure](https://blog.alexellis.io/lock-down-openfaas/) the OpenFaaS functions

--

##### Resources

1. Slides - http://mherman.org/presentations/pycon-2018
1. Repo - https://github.com/testdrivenio/openci
1. ***[Testdriven.io](http://testdriven.io/) - full course!*** ‚ù§Ô∏è
1. [How to Build 12 Factor Microservices on Docker](https://www.packtpub.com/books/content/how-to-build-12-factor-design-microservices-on-docker-part-1)
1. [Docker Cheat Sheet](https://github.com/wsargent/docker-cheat-sheet)
1. https://docs.docker.com/develop/develop-images/dockerfile_best-practices/
1. https://docs.docker.com/develop/dev-best-practices/


<div>
  <img src="images/mobile_image.png" style="max-width: 11%; border:0; box-shadow: none;" alt="testdriven.io">
</div>

--

##### Questions?

‚úåÔ∏è


    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
